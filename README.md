# Setting up a Redis Sentinel cluster
In this example I'll show you how to setup 3 machines as Redis server and how to archieve high avaliability and redundancy.

## Before you begin
1. (Optional) If you want to make the redis server to be avaliable from the host network, in the `Vagrantfile` you must specify on what interface to expose the redis servers.

        config.vm.network "public_network", type: "dhcp", bridge: "interface_name"

2. Populate the `cluster.yaml` files whith the definition of all the servers you desire to have in the cluster.
    An example of a 3 servers configuration:

        severs:
          - ip: 192.168.56.10
            hostname: luke
            is_replica: no

          - ip: 192.168.56.20
            hostname: han
            is_replica: yes

          - ip: 192.168.56.30
            hostname: leia
            is_replica: yes

    `ip`: the ip assign to the VM on the private network created by the virtualizator.

    `hostname`: machine hostname

    `is_replica`: wheter this server is a replica (`yes`) or the leader (`no`).
    There can be only one leader, otherwise the 

3. Have Ansible installed on the host machine.
    Also, install the Ansible role `redis_sentinel_cluster`:

        ansible-galaxy install git+https://github.com/Mot93/redis_sentinel_cluster.git

## Creating the VM
The VM can will be created by [Vagrant](https://www.vagrantup.com/).

In order to create and lauch the VM, use the following Vagrant command.

    vagrant up

Once done, destroy the vms:

    vagrant destroy

## Lauching ansible against the vagrant machines
Once the machines have been created, they have to be provvisioned.
The tool used by this example to setup the cluster is [Ansible](https://www.redhat.com/en/technologies/management/ansible).

### TIPS:

It's possible to relaunch the playbook `playbook.yml` against the machines made by Vagrant using an inventory autogenerated by Vagrant specifying the inventory path:

    ansible-playbook playbook.yml -i .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory

To automate this process, it's possible to configure ansible via the `ansible.cfg` file.
To create the file: 

    ansible-config init --disabled > ansible.cfg

Configure the `ansible.cfg` file:

1. Set the inventory to the one generated by vagrant:

        inventory=./.vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory

2. Prevent ansuble from cheching the new VM ssh key:

        host_key_checking=False

3. Specify where the role folder is stored:
        
        roles_path=/path/to/role/

## Checking installation
In order to to check if the setup works, stop the redis on the main server:

    vagrant ssh <vm leader name>
    redis-cli -p 6379 DEBUG sleep 30

Afterward, check on all tree machines if a new leader has been elected and that it's the same on all tree

    vagrant ssh <vm name>
    redis-cli -p 26379 sentinel master redis_replica
